{"ast":null,"code":"var _jsxFileName = \"/Users/niko/digital-human/frontend/src/components/DigitalHuman/index.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from 'react';\nimport './DigitalHuman.css';\nimport { useConfig } from '../../contexts/ConfigContext';\nimport { useNotification } from '../../contexts/NotificationContext';\nimport { useWebSocket } from '../../contexts/WebSocketContext';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst DigitalHuman = () => {\n  _s();\n  const containerRef = useRef(null);\n  const videoRef = useRef(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [currentVideo, setCurrentVideo] = useState(null);\n  const {\n    config\n  } = useConfig();\n  const {\n    success,\n    error: showError\n  } = useNotification();\n  const {\n    lastMessage\n  } = useWebSocket();\n\n  // 监听WebSocket消息以获取视频更新\n  useEffect(() => {\n    if (lastMessage && lastMessage.type === 'video_ready') {\n      setCurrentVideo(lastMessage.video_url);\n      setLoading(false);\n    }\n  }, [lastMessage]);\n\n  // 初始化EchoMimic容器\n  useEffect(() => {\n    let mounted = true;\n    const initEchoMimic = async () => {\n      try {\n        setLoading(true);\n        setError(null);\n\n        // 确保容器已渲染\n        const container = containerRef.current;\n        if (!container) {\n          throw new Error('容器元素不存在');\n        }\n\n        // 如果有视频元素，确保它可见\n        const videoElement = videoRef.current;\n        if (videoElement) {\n          videoElement.style.display = 'block';\n        }\n        if (mounted) {\n          setLoading(false);\n          success('数字人准备就绪');\n        }\n      } catch (err) {\n        console.error('初始化数字人失败:', err);\n        if (mounted) {\n          setError(err.message || '数字人初始化失败');\n          setLoading(false);\n          showError('数字人初始化失败: ' + (err.message || '未知错误'));\n        }\n      }\n    };\n\n    // 延迟初始化以确保DOM已完全加载\n    const timer = setTimeout(() => {\n      initEchoMimic();\n    }, 1000);\n    return () => {\n      clearTimeout(timer);\n      mounted = false;\n    };\n  }, [success, showError, config]);\n\n  // 当有新视频时播放\n  useEffect(() => {\n    if (currentVideo && videoRef.current) {\n      videoRef.current.src = currentVideo;\n      videoRef.current.load();\n      videoRef.current.play().catch(e => console.error('视频播放失败:', e));\n    }\n  }, [currentVideo]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"digital-human-section\",\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"model-container\",\n      ref: containerRef,\n      children: [/*#__PURE__*/_jsxDEV(\"video\", {\n        ref: videoRef,\n        className: \"echomimic-video\",\n        controls: true,\n        muted: false,\n        loop: true,\n        playsInline: true,\n        style: {\n          display: currentVideo ? 'block' : 'none'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 84,\n        columnNumber: 9\n      }, this), loading && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"model-placeholder\",\n        children: [/*#__PURE__*/_jsxDEV(\"i\", {\n          className: \"fas fa-spinner fa-spin\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 96,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          children: \"\\u6570\\u5B57\\u4EBA\\u51C6\\u5907\\u4E2D...\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 97,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 95,\n        columnNumber: 11\n      }, this), error && !loading && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"model-placeholder error\",\n        children: [/*#__PURE__*/_jsxDEV(\"i\", {\n          className: \"fas fa-exclamation-triangle\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 103,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          children: \"\\u6570\\u5B57\\u4EBA\\u521D\\u59CB\\u5316\\u5931\\u8D25\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 104,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"error-message\",\n          children: error\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 105,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"retry-button\",\n          onClick: () => window.location.reload(),\n          children: \"\\u5237\\u65B0\\u9875\\u9762\\u91CD\\u8BD5\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 106,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 102,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 82,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 81,\n    columnNumber: 5\n  }, this);\n};\n_s(DigitalHuman, \"YPaJlFCERuNy2mSnCINJNUsdPTA=\", false, function () {\n  return [useConfig, useNotification, useWebSocket];\n});\n_c = DigitalHuman;\nexport default DigitalHuman;\nvar _c;\n$RefreshReg$(_c, \"DigitalHuman\");","map":{"version":3,"names":["React","useEffect","useRef","useState","useConfig","useNotification","useWebSocket","jsxDEV","_jsxDEV","DigitalHuman","_s","containerRef","videoRef","loading","setLoading","error","setError","currentVideo","setCurrentVideo","config","success","showError","lastMessage","type","video_url","mounted","initEchoMimic","container","current","Error","videoElement","style","display","err","console","message","timer","setTimeout","clearTimeout","src","load","play","catch","e","className","children","ref","controls","muted","loop","playsInline","fileName","_jsxFileName","lineNumber","columnNumber","onClick","window","location","reload","_c","$RefreshReg$"],"sources":["/Users/niko/digital-human/frontend/src/components/DigitalHuman/index.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport './DigitalHuman.css';\nimport { useConfig } from '../../contexts/ConfigContext';\nimport { useNotification } from '../../contexts/NotificationContext';\nimport { useWebSocket } from '../../contexts/WebSocketContext';\n\nconst DigitalHuman = () => {\n  const containerRef = useRef(null);\n  const videoRef = useRef(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [currentVideo, setCurrentVideo] = useState(null);\n  const { config } = useConfig();\n  const { success, error: showError } = useNotification();\n  const { lastMessage } = useWebSocket();\n\n  // 监听WebSocket消息以获取视频更新\n  useEffect(() => {\n    if (lastMessage && lastMessage.type === 'video_ready') {\n      setCurrentVideo(lastMessage.video_url);\n      setLoading(false);\n    }\n  }, [lastMessage]);\n\n  // 初始化EchoMimic容器\n  useEffect(() => {\n    let mounted = true;\n    \n    const initEchoMimic = async () => {\n      try {\n        setLoading(true);\n        setError(null);\n        \n        // 确保容器已渲染\n        const container = containerRef.current;\n        if (!container) {\n          throw new Error('容器元素不存在');\n        }\n        \n        // 如果有视频元素，确保它可见\n        const videoElement = videoRef.current;\n        if (videoElement) {\n          videoElement.style.display = 'block';\n        }\n        \n        if (mounted) {\n          setLoading(false);\n          success('数字人准备就绪');\n        }\n      } catch (err) {\n        console.error('初始化数字人失败:', err);\n        if (mounted) {\n          setError(err.message || '数字人初始化失败');\n          setLoading(false);\n          showError('数字人初始化失败: ' + (err.message || '未知错误'));\n        }\n      }\n    };\n    \n    // 延迟初始化以确保DOM已完全加载\n    const timer = setTimeout(() => {\n      initEchoMimic();\n    }, 1000);\n    \n    return () => {\n      clearTimeout(timer);\n      mounted = false;\n    };\n  }, [success, showError, config]);\n\n  // 当有新视频时播放\n  useEffect(() => {\n    if (currentVideo && videoRef.current) {\n      videoRef.current.src = currentVideo;\n      videoRef.current.load();\n      videoRef.current.play().catch(e => console.error('视频播放失败:', e));\n    }\n  }, [currentVideo]);\n\n  return (\n    <div className=\"digital-human-section\">\n      <div className=\"model-container\" ref={containerRef}>\n        {/* EchoMimic视频播放器 */}\n        <video \n          ref={videoRef}\n          className=\"echomimic-video\"\n          controls\n          muted={false}\n          loop\n          playsInline\n          style={{ display: currentVideo ? 'block' : 'none' }}\n        />\n        \n        {loading && (\n          <div className=\"model-placeholder\">\n            <i className=\"fas fa-spinner fa-spin\"></i>\n            <p>数字人准备中...</p>\n          </div>\n        )}\n        \n        {error && !loading && (\n          <div className=\"model-placeholder error\">\n            <i className=\"fas fa-exclamation-triangle\"></i>\n            <p>数字人初始化失败</p>\n            <p className=\"error-message\">{error}</p>\n            <button \n              className=\"retry-button\"\n              onClick={() => window.location.reload()}\n            >\n              刷新页面重试\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default DigitalHuman;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}