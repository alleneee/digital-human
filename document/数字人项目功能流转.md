flowchart TB
    subgraph 用户交互层
        UserText["用户文本输入"]
        UserVoice["用户语音输入"]
    end
    
    subgraph 前端系统
        WebSocket["WebSocket客户端"]
        FrontText["文本消息处理"]
        FrontVoice["语音记录处理"]
        UI["界面渲染与更新"]
        Live2D["Live2D模型控制"]
        AudioPlayer["音频播放器"]
    end
    
    subgraph 后端系统
        WSServer["WebSocket服务"]
        
        subgraph 输入处理
            TextHandler["文本输入处理"]
            AudioHandler["音频数据处理"]
        end
        
        subgraph 核心处理
            ASR["Deepgram语音识别\n(ASR)"]
            LLM["Gemini LLM处理"]
            Memory["对话记忆管理"]
            Emotion["情感分析"]
            TTS["Deepgram文本转语音\n(TTS)"]
        end
        
        subgraph 响应生成
            AnimControl["动画控制信号生成"]
            ResponseFormat["响应格式化"]
        end
    end
    
    %% 用户交互流程
    UserText --> FrontText
    UserVoice --> FrontVoice
    
    %% 前端处理
    FrontText --> WebSocket
    FrontVoice --> WebSocket
    
    %% WebSocket通信
    WebSocket --> |"发送消息"| WSServer
    WSServer --> |"接收消息"| WebSocket
    
    %% 后端输入处理
    WSServer --> |"文本数据"| TextHandler
    WSServer --> |"音频数据"| AudioHandler
    
    %% 语音识别
    AudioHandler --> ASR
    ASR --> |"识别文本"| TextHandler
    
    %% 对话生成
    TextHandler --> LLM
    Memory --> |"提供上下文"| LLM
    LLM --> |"更新记忆"| Memory
    LLM --> |"生成回复"| Emotion
    
    %% 情感分析与动画控制
    Emotion --> |"情感标签"| AnimControl
    
    %% 文本转语音
    Emotion --> |"带情感文本"| TTS
    
    %% 响应组装
    AnimControl --> ResponseFormat
    TTS --> |"音频数据"| ResponseFormat
    
    %% 响应发送
    ResponseFormat --> WSServer
    
    %% 前端显示
    WebSocket --> |"文本响应"| UI
    WebSocket --> |"动画控制"| Live2D
    WebSocket --> |"音频数据"| AudioPlayer
    
    %% 界面更新
    UI --> |"更新聊天界面"| UserText
    Live2D --> |"数字人动画"| UserText
    AudioPlayer --> |"语音播放"| UserText
    
    %% 样式
    classDef userInput fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef frontend fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef deepgram fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef llm fill:#e8eaf6,stroke:#283593,stroke-width:2px
    
    class UserText,UserVoice userInput
    class WebSocket,FrontText,FrontVoice,UI,Live2D,AudioPlayer frontend
    class WSServer,TextHandler,AudioHandler,AnimControl,ResponseFormat backend
    class ASR,TTS deepgram
    class LLM,Memory,Emotion llm