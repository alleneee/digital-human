# 数字人框架架构文档

本文档详细介绍数字人框架的架构设计、核心组件和交互流程，帮助开发者更好地理解和扩展该框架。

## 核心组件

### 1. 引擎模块 (`engine/`)

引擎模块是框架的核心处理单元，包含三种主要引擎类型：

#### 1.1 ASR引擎 (`engine/asr/`)

语音识别引擎负责将音频输入转换为文本。目前支持：

- **FunASR本地引擎**：使用开源的FunASR模型进行本地语音识别
- **Deepgram API**：通过Deepgram云服务进行语音识别

每个ASR引擎实现都继承自`BaseEngine`，并通过工厂模式创建和管理。

#### 1.2 LLM引擎 (`engine/llm/`)

大语言模型引擎负责理解文本输入并生成回复。目前支持：

- **OpenAI LLM**：使用OpenAI API接入GPT系列模型
- **MiniMax LLM**：使用MiniMax API接入MiniMax文本模型

#### 1.3 TTS引擎 (`engine/tts/`)

语音合成引擎负责将文本转换为语音。目前支持：

- **Edge TTS**：使用Microsoft Edge TTS服务
- **MiniMax TTS**：使用MiniMax语音合成API
- **Deepgram TTS**：使用Deepgram语音合成服务

### 2. 处理管道 (`pipelines/`)

处理管道负责协调各个引擎组件之间的数据流转和处理逻辑。

#### 2.1 对话管道 (`pipelines/conversation.py`)

对话管道实现了完整的ASR->LLM->TTS流程，处理从语音输入到语音输出的整个过程：

1. 接收音频输入并使用ASR引擎转换为文本
2. 将文本输入传递给LLM引擎生成回复
3. 使用TTS引擎将回复文本转换为语音输出

#### 2.2 语音处理器 (`pipelines/speech.py`)

语音处理器提供音频处理相关功能，如音频格式转换、静音检测、分段等：

1. 格式转换：将不同格式的音频转换为引擎所需格式
2. 音频分析：分析音频特性，如音量、持续时间等
3. 音频预处理：进行降噪、增益调整等预处理操作

### 3. API接口 (`api/`)

API模块提供HTTP和WebSocket接口，允许客户端与数字人框架交互。

#### 3.1 API路由 (`api/routes.py`)

定义了以下主要接口：

- 文本聊天：接收文本输入，返回文本和语音回复
- 音频聊天：接收音频输入，返回文本和语音回复
- 语音识别：仅执行ASR功能
- 语音合成：仅执行TTS功能
- 健康检查：检查服务运行状态

### 4. 集成模块 (`integrations/`)

集成模块封装了与第三方服务的交互逻辑：

- **Deepgram集成**：封装与Deepgram ASR和TTS API的交互
- **MiniMax集成**：封装与MiniMax LLM和TTS API的交互

### 5. 工具函数 (`utils/`)

提供各种辅助功能和通用工具：

- **配置管理**：加载和合并YAML配置文件
- **音频处理**：音频格式检测、转换等功能
- **协议定义**：定义消息和数据结构
- **缓存管理**：实现TTS结果缓存等功能

### 6. 配置系统 (`configs/`)

配置系统使用YAML格式，包括：

- **全局配置**：应用级配置，包括API设置、日志等
- **引擎配置**：各引擎特定的配置参数

## 数据流转过程

1. **客户端请求**：通过API接口发送文本或音频请求
2. **API路由处理**：解析请求并传递给相应的处理逻辑
3. **对话管道处理**：
   - 音频输入 -> ASR引擎 -> 文本
   - 文本 -> LLM引擎 -> 回复文本
   - 回复文本 -> TTS引擎 -> 语音输出
4. **结果返回**：通过API将处理结果返回给客户端

## 扩展框架

### 添加新的ASR引擎

1. 在`engine/asr/`目录下创建新引擎实现类
2. 继承`BaseEngine`类并实现必要方法
3. 使用ASR工厂的装饰器注册新引擎
4. 在`configs/engines/asr/`目录下添加配置文件

### 添加新的LLM引擎

1. 在`engine/llm/`目录下创建新引擎实现类
2. 继承`BaseEngine`类并实现必要方法
3. 使用LLM工厂的装饰器注册新引擎
4. 在`configs/engines/llm/`目录下添加配置文件

### 添加新的TTS引擎

1. 在`engine/tts/`目录下创建新引擎实现类
2. 继承`BaseEngine`类并实现必要方法
3. 使用TTS工厂的装饰器注册新引擎
4. 在`configs/engines/tts/`目录下添加配置文件
